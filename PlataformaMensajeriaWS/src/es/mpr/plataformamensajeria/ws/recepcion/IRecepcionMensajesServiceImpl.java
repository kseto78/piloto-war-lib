
/**
 * Please modify this class to meet your needs
 * This class is not complete
 */

package es.mpr.plataformamensajeria.ws.recepcion;

import es.mpr.plataformamensajeria.beans.RecepcionSMSBean;
import es.mpr.plataformamensajeria.jdbc.RecepcionSMSDAO;
import es.mpr.plataformamensajeria.util.WSPlataformaErrors;

/**
 * This class was generated by Apache CXF 2.6.3
 * Generated source version: 2.6.3
 * 
 */

@javax.jws.WebService(
                      serviceName = "RecepcionMensajesImplService",
                      portName = "RecepcionMensajesImplPort",
                      targetNamespace = "http://recepcion.ws.plataformamensajeria.minhap.es/",
                      wsdlLocation = "/wsdl/respuestaSMS.wsdl",
                      endpointInterface = "es.mpr.plataformamensajeria.ws.recepcion.IRecepcionMensajesService")
                      
public class IRecepcionMensajesServiceImpl implements IRecepcionMensajesService {
	
	static final String TAG_OK = "OK";
	static final String TAG_KO = "KO";
	static final String TAG_STATUSCODE_OK = "1000";
	static final String TAG_ERROR_PARAMETROS_PETICION = "3000";
	static final String TAG_ERROR_AUTENTICACION_LOTE = "3001";
	static final String TAG_ERROR_SERVICIO_INCORRECTO = "3002";
	static final String TAG_ERROR_SERVICIO_INACTIVO = "3003";
	static final String TAG_ERROR_LOTE = "3004";
	static final String TAG_ERROR_AUTENTICACION_SMS = "3005";
	static final String TAG_ERROR_CANAL_SMS = "3006";
	static final String TAG_ERROR_DESTINATARIO_SMS = "3007";
	static final String TAG_ERROR_SMS = "3008";
	static final String TAG_ERROR_RECEPCION_MENSAJE = "4001";
	static final String TAG_ERROR_NO_SERVICIO = "4002";
	static final String TAG_ERROR_SERVICIO_DUPLICADO = "4003";
	static final String TAG_ERROR_VALIDACION_USER_PASSWORD = "4004";
	static final String TAG_ERROR_VALIDACION_USER_PASSWORD_VARIOS_SERVIDORES = "4005";
	static final String TAG_MENSAJE_OK = "Petición procesada correctamente";
	static final String TAG_MENSAJE_KO_GENERAL = "Se ha producido un error procesando la recepcion";
	static final String TAG_MENSAJE_KO_PARAMETROS_PETICION  = "La peticion no está construida correctamente. Faltan campos obligatorios";
	static final String TAG_MENSAJE_KO_NO_SERVICIO = "No existe un servicio con el HEADERSMS de la petición o está inactivo";
	static final String TAG_MENSAJE_KO_SERVICIO_DUPLICADO = "Existe mas de un servicio activo con el HEADERSMS de la petición";
	static final String TAG_MENSAJE_KO_VALIDACION_USER_PASSWORD = "El usuario/password no coincide con el del servidor o existe mas de un servidor";
	static final String TAG_MENSAJE_KO_VALIDACION_USER_PASSWORD_VARIOS_SERVIDORES = "El servidor no esta relacionado con el servicio";

    /* (non-Javadoc)
     * @see es.mpr.plataformamensajeria.ws.recepcion.IRecepcionMensajesService#recibirSMS(es.minhap.plataformamensajeria.ws.recepcion.RecibirSMSRequest  parameters )*
     */
    public RecibirSMSResponse recibirSMS(RecibirSMSRequest recibirSMSRequest) {
        
        RecibirSMSResponse _return = new RecibirSMSResponse();
        _return.setStatus(new ResponseStatusType());
        
        Integer idLote=null;
        
        RecepcionSMSDAO dao = new RecepcionSMSDAO();
        RecepcionSMSBean envioSMS = new RecepcionSMSBean();
        
        dao.beginTransaction();
        try {
        	
        	boolean peticionCorrecta = evaluarPeticion(recibirSMSRequest);
        	
        	if(peticionCorrecta){
        		
        		envioSMS = dao.consultarLote(recibirSMSRequest.getRecipient(), recibirSMSRequest.getUser(), recibirSMSRequest.getPassword());
            	//Se valida que se haya recuperado correctamente la informacion de base de datos
        		if(!envioSMS.getServicio().equals("-1") && !envioSMS.getServicio().equals("-2") 
        				&& !envioSMS.getServicio().equals("-4") && !envioSMS.getServicio().equals("-5")){
            		idLote = dao.crearLote(envioSMS.getServicio(), envioSMS.getNombreLote(), envioSMS.getUserAplicacion(), envioSMS.getPasswordAplicacion());
        			String errorCrearLote = (WSPlataformaErrors.getErrorCrearLote(idLote));
        			if(errorCrearLote!=null){
        				Integer value = Integer.parseInt(errorCrearLote);
        				switch (value) {
        				case -1:
        					_return.getStatus().setStatusCode(TAG_ERROR_AUTENTICACION_LOTE);
        					break;
        				case -2:
        					_return.getStatus().setStatusCode(TAG_ERROR_SERVICIO_INCORRECTO);
        					break;
        				case -3:
        					_return.getStatus().setStatusCode(TAG_ERROR_SERVICIO_INACTIVO);
        					break;
        				case -10:
        					_return.getStatus().setStatusCode(TAG_ERROR_LOTE);
        					break;
        				default:
        					_return.getStatus().setStatusCode(TAG_ERROR_RECEPCION_MENSAJE);
        					break;
        				}
        				_return.getStatus().setStatusText(TAG_KO);
        				_return.getStatus().setDetails(WSPlataformaErrors.getErrorCrearLote(idLote));
        				dao.endTransaction(false);
        				dao.closeAll();
        				return _return;
        			}
        			
        			Integer idMensaje = dao.crearSMS(idLote, recibirSMSRequest.getSMSText(), recibirSMSRequest.getMessageId(), recibirSMSRequest.getSender(), 
        					envioSMS.getUserAplicacion(), envioSMS.getPasswordAplicacion());
        			String errorCrearSMS = WSPlataformaErrors.getErrorCrearSMS(idMensaje);
        			if(errorCrearSMS!=null){
        				Integer value = Integer.parseInt(errorCrearLote);
        				switch (value) {
        				case -1:
        					_return.getStatus().setStatusCode(TAG_ERROR_AUTENTICACION_SMS);
        					break;
        				case -2:
        					_return.getStatus().setStatusCode(TAG_ERROR_CANAL_SMS);
        					break;
        				case -3:
        					_return.getStatus().setStatusCode(TAG_ERROR_DESTINATARIO_SMS);
        					break;
        				case -10:
        					_return.getStatus().setStatusCode(TAG_ERROR_SMS);
        					break;
        				default:
        					_return.getStatus().setStatusCode(TAG_ERROR_RECEPCION_MENSAJE);
        					break;
        				}
        				_return.getStatus().setStatusText(TAG_KO);
        				_return.getStatus().setDetails(WSPlataformaErrors.getErrorCrearSMS(idMensaje));
        			}
        			dao.connClose();
        			
        			_return.getStatus().setStatusCode(TAG_STATUSCODE_OK);
        			_return.getStatus().setStatusText(TAG_OK);
        			_return.getStatus().setDetails(TAG_MENSAJE_OK);
    	        	
            	} else if(envioSMS.getServicio().equals("-1")) {
            		_return.getStatus().setStatusCode(TAG_ERROR_NO_SERVICIO);
        			_return.getStatus().setStatusText(TAG_KO);
        			_return.getStatus().setDetails(TAG_MENSAJE_KO_NO_SERVICIO);
            	} else if(envioSMS.getServicio().equals("-2")){
            		_return.getStatus().setStatusCode(TAG_ERROR_SERVICIO_DUPLICADO);
        			_return.getStatus().setStatusText(TAG_KO);
        			_return.getStatus().setDetails(TAG_MENSAJE_KO_SERVICIO_DUPLICADO);
            	} else if(envioSMS.getServicio().equals("-4")){
            		_return.getStatus().setStatusCode(TAG_ERROR_VALIDACION_USER_PASSWORD);
            		_return.getStatus().setStatusText(TAG_KO);
        			_return.getStatus().setDetails(TAG_MENSAJE_KO_VALIDACION_USER_PASSWORD);
            	} else if(envioSMS.getServicio().equals("-5")){
            		_return.getStatus().setStatusCode(TAG_ERROR_VALIDACION_USER_PASSWORD_VARIOS_SERVIDORES);
            		_return.getStatus().setStatusText(TAG_KO);
        			_return.getStatus().setDetails(TAG_MENSAJE_KO_VALIDACION_USER_PASSWORD_VARIOS_SERVIDORES);
            	}   

        	} else {
        		_return.getStatus().setStatusCode(TAG_ERROR_PARAMETROS_PETICION);
    			_return.getStatus().setStatusText(TAG_KO);
    			_return.getStatus().setDetails(TAG_MENSAJE_KO_PARAMETROS_PETICION);
        	}
        	
		} catch (Exception e) {
			_return.getStatus().setStatusCode(TAG_ERROR_RECEPCION_MENSAJE);
			_return.getStatus().setStatusText(TAG_KO);
			_return.getStatus().setDetails(TAG_MENSAJE_KO_GENERAL);
		}finally{
			if(_return!=null&&_return.getStatus().getStatusCode().equals(TAG_STATUSCODE_OK)){
				dao.endTransaction(true);
			}else{
				dao.endTransaction(false);
			}
			dao.closeAll();
		}
		return _return;
    }
    
    private boolean evaluarPeticion(RecibirSMSRequest recibirSMSRequest){
    	
    	if(evaluarParametro(recibirSMSRequest.getUser()) && evaluarParametro(recibirSMSRequest.getPassword())
    			&& evaluarParametro(recibirSMSRequest.getSender()) && evaluarParametro(recibirSMSRequest.getRecipient())
    			&& evaluarParametro(recibirSMSRequest.getMessageId()) && evaluarParametro(recibirSMSRequest.getMessageId())){
    		return true;
    	} else {
    		return false;
    	}
    	
    }
    
    private boolean evaluarParametro(String parametro){
    	
    	if(null!=parametro && !parametro.isEmpty()){
    		return true;
    	} else {
    		return false;
    	}
    }

}
